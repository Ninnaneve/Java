# MySQL用户自定义函数
## 基本语法
``` mysql
create function <db_name>.<func_name> (param1, param2, ...) returns data_type
[funciton options]
begin
body;
return sentence;
end;
```
函数选项如下:
- language sql 默认选项，用于说明函数体用sql编写。
- [not] deterministic如果对相同输入得到**相同输出结果**，则为deterministic，否则为not deterministic(默认值)
- 函数体是否包含SQL
  - contains sql ：表明函数体不包含读或写数据的语句（如set） （默认值）
  - no sql ： 表明函数体中不包含sql语句
  - reads sql data ： 包含select查询
  - modifies sql data：包含update或delete或replace
- sql security 用于指定函数的执行许可
- definer 表明函数只能有创建者调用
- invoker 表明函数可以被其它创建者调用 （默认值）
- comment 注释

> 注意：
> - 创建自定义函数时，不能与已有的函数名（包括系统名）重复。此外，建议在自定义函数名中统一添加**前缀fn_或者后缀_fn*。
> - **函数的参数**无需使用declare命令定义，但它仍属于局域变量，且必须**提供参数的数据类型**。
> - **函数体内部的变量**需要**用declare命令定义**。
> - 自定义函数如果没有参数，则使用空参数()即可。
> - 函数必须指定返回值的数据类型，且需与return预计中的返回值的数据类型相近（长度可以不同）。

例如，定义函数查询行号, 每返回一行，行号+1.
> Q：主要是不明白select的查找机制和用户自定义变量的更新机制，因此对怎么循环这个问题感到很疑惑。

``` mysql
delimiter $$
create function row_no_fn() returns int
no sql
begin
set @row_no=@row_no+1;
return @row_no;
end;
$$
delimiter ; # 这里的空格容易忘记

set @row_no=0; -- 初始化会话变量
select row_no_fn() as 行号, product_id, product_name, product_place
from product
limit 10;

-- 等价于
select @row_no:=@row_no+1 as 行号, product_id, product_name, product_place
from product, (select @row_no:=0) as r;
```
> 注意：
在MySQL命令行的客户端中，服务器处理语句默认**以;作为结束标志**，如果有一行命令以分号结束，那么按【ENTER】键后，服务器将执行该命令。
在存储程序（如函数、触发器、存储过程、事件）中往往涉及到多个命令，如果仍然以分号作为结束标志，那么执行完第一分号语句后，就会认为程序结束。此时，可以通过**重新定义结束符**来解决该问题。delimiter $$将结束符设置为$$。如此设置之后，MySQL Server将不同$$之间的语句作一个语句块同时处理。当然，也可以定义其它的结束符，如//等。

例如，定义函数get_product_number_fn, 输入类别编号(sort_id)，输出该类别下的产品数量
> 建议的函数形参定义方法：表名开头字母+属性名称

``` mysql
delimiter $$
create function get_product_number_fn(p_sort_id char(4)), returns int
reads sql data
begin
declare p_product_num int;
select count(*) into p_product_num
from product
where sort_id=p_sort_id;
return p_product_num;
end;
$$
delimiter ;

set @v_sort_id =11;
select @v_sort_id as 类别编号, @get_product_number_fn(@v_sort_id) as 产品数量;
```
例如，定义函数get_sum_sort_fn，输入产品编号，返回其产品类别下子类别的数量
``` mysql
delimiter $$
create function get_sum_sort_fn(p_productid char()), returns int
reads sql data
begin
declare subsort_num int;
select count(subsort_num) into subsort_num
from subsort
where sort_id in (select sort_id from product where product_id='p+productid');
return subsort_num;
end;
$$
delimiter ;

set @p_productid='1001';
select get_sum_sort_fn(@p_productid) as 子类别数量;
```
## 查看函数定义
- 查询完整的函数定义语句
``` mysql
show create function 函数名;
```
- 查看用户定义的函数
> 具体条件还可以补充
``` mysql
show function status [where | like]+条件;
```
例如，
``` mysql
show function status where definer='root@localhost';
show function status where db='purchase';
show function status like 'get_sum%';
```



# 分支与循环语句

## 分支
### if语句
``` mysql
If 条件表达式1 then 语句块1;
[elseif 条件表达式2 then 语句块2];
...
[else 语句块n]
end if;
```
例如，创建函数change_price_fn,输入产品编号product_id，根据sort_id的值计算并返回返利: sort_id为11的产品返利为价格的10%， sort_id为21的产品的产品返利为价格的30%，sort_id为31的产品返利为价格的40%, 其它返回为5%。
> if 判定条件 需要加括号！

``` mysql
delimiter $$
create function change_price_fn(p_product_id char(5)), returns decimal(10,2)
reads sql function
begin
declare rebate decimal(10,2);
declare p_sortid char(2);
select sort_id into p_sort_id
from product
where product_id=p_product_id;
if (p_sort_id='11') then
select price*0.1 into rebate
from product
where sort_id=p_sort_id;
elseif (p_sort_id='21') then 
select price*0.3 into rebate
from product
where sort_id=p_sort_id;
elseif (p_sort_id='31') then
select price*0.4 into rebate 
from product
where sort_id=p_sort_id;
else select price*0.05 into rebate
from product
where sort_id=p_sort_id;
end if;
return rebate;
end;
$$
delimiter ;

select product_id, sort_id, cal_rebate_fn(product_id) as rebate
from product;
```

### case 语句
``` mysql
case 表达式
when value1 then 语句块1;
when value2 then 语句块2;
...
when value(n-1) then 语句块n-1;
else 语句块n;
end case;
```
例如，创建get_week_fn()函数，使用该函数根据mysql系统时间打印星期几
> weekday可以返回和星期相关的数值

``` mysql
drop function if exists get_week_fn;

delimiter $$
create function get_week_fn() returns char(6)
no sql
begin
declare weekday char(6);
declare sys_week int;
select weekday(now()) into sys_week;
case
when sys_week=0 then set weekday='星期一';
when sys_week=1 then set weekday='星期二';
when sys_week=2 then set weekday='星期三';
when sys_week=3 then set weekday='星期四';
when sys_week=4 then set weekday='星期五';
when sys_week=5 then set weekday='星期六';
else set weekday='星期日';
end case;
return weekday;
end;
$$
delimiter ;

select get_week_fn();
```

## 分支
### while
当条件表达式为true时，反复执行循环体，直到表达式值为false。
``` mysql
[循环标签:] while 条件表达式 do
循环体;
end while [循环标签];
```
例如，创建函数get_sum_fn，输入n，返回整数1到n的累加和
> 条件表达式要加括号。

``` mysql
drop function if exists get_sum_fn;

delimiter $$
create function get_sum_fn(n int) returns int
no sql
begin
declare cumsum int default 0;
declare acc_time int default 0;
while (acc_time<n) do
set acc_time=acc_time+1;
set cumsum=cumsum+acc_time;
end while;
return cumsum;
end;
$$
delimiter ;

select get_sum_fn(5);
```

### leave
用于跳出当前的循化语句，相当于python中的break。
``` mysql
leave 循环标签;
```
例如，基于leave语句，创建函数get_sum_fn2，输入n，返回整数1到n的累加和
> 使用时while前要有循环标签。
容易忘记的标签：end if; end while 循环标签;

``` mysql
delimiter $$
create function get_sum_fn2(n int) returns int
no sql
begin
declare cumsum int default 0;
declare acc_time int default 0;
add_num: while true do
set acc_time=acc_time+1;
set cumsum=cumsum+acc_time;
if (acc_time=n) then leave add_num;
end if;
end while add_num;
return cumsum;
end;
$$
delimiter ;

select get_sum_fn2(5);
```

### iterate
用于跳出本次循环，继续下次循环，相当于python中的continue。
``` mysql
iterate 循环标签;
```
例如，基于iterate，输入n，对1~n内所有能被3整除的数加和
``` mysql
drop function if exists get_sum_fn3;

delimiter $$
create function get_sum_fn3(n int) returns int
no sql
begin
declare cumsum int default 0;
declare acc_time int default 0;
add_num: while acc_time<n do
set acc_time=acc_time+1;
if (acc_time%3!=0) then iterate add_num;
end if;
set cumsum=cumsum+acc_time;
end while add_num;
return cumsum;
end;
$$
delimiter ;

select get_sum_fn3(10);
```

### repeat
当条件表达式的值为false时，反复执行循环，直到条件表达式的值为true。
``` mysql
[循环标签:] repeate
循环体;
until 条件表达式
end repeat[循环标签];
```
例如，基于repeat定义函数，输入n, 实现从1到n的累加和
``` mysql
delimiter $$
create function get_sum_fn4(n int) returns int
no sql
begin
declare cumsum int default 0;
declare acc_time int default 0;
repeat
set acc_time=acc_time+1;
set cumsum=cumsum+acc_time;
until acc_time=n
end repeat;
return cumsum;
end;
$$
delimiter ;

select get_sum_fn4(5);
```

### loop
loop通常借助leave语句跳出循环。
``` mysql
[循环标签:]loop
循环体;
if 条件表达式 then
    leave [循环标签];
end if;
end loop;
```
例如，基于loop，输入n，实现从1加到n的累加和
``` mysql
drop function if exists get_sum_fn5;

delimiter $$
create function get_sum_fn5(n int) returns int
no sql
begin
declare cumsum int default 0;
declare acc_time int default 0;
add_sum:loop
set acc_time=acc_time+1;
set cumsum=cumsum+acc_time;
if (acc_time=n) then leave add_sum;
end if;
end loop;
return cumsum;
end;
$$
delimiter ;

select get_sum_fn5(5);
```



# Exercise

## 1
- 定义函数get_product_number_fn, 输入产地名称，输出该产地下的产品类别数量
``` mysql
delimiter $$
create function get_product_number_fn(p_place char(10)) returns int
reads sql data
begin
declare product_num int;
select count(product_id) into product_num
from product
where product_place=p_place;
end;
$$
delimiter ;
```
- 定义函数get_member_num_fn，输入省份，返回该省份中的用户数量; 然后查看该函数的定义。
> 这里处理字符是方式特别巧妙，值得借鉴，用了concat形成类似正则表达式的结构。

``` mysql
drop function if exists get_member_num_fn;

delimiter $$
create function get_member_num_fn (p_province char(4)) returns int
reads sql data
begin
declare v_memberid int;
select count(*) into v_memberid
from member
where address like concat(p_province,'%');
return v_memberid;
end;
$$
delimiter ;

select get_member_num_fn('浙江') as '用户数量';
```
## 2
- 创建函数func, 输入$x$，当时$x<5$，$y=x^3$; 当$-5<=x<5$时，$y=x$; 当$x>=5$时，$y=2x+1$，返回$y$.
``` mysql
drop function if exists func;

delimiter $$
create function func(x int) returns int
no sql
begin
declare y int;
if (x<-5) then set y=x*x*x;
elseif (x<5) then set y=x;
else set y=2*x+1;
end if;
return y;
end;
$$
delimiter ;

select func(4);
```
- 创建函数cal_due_fn，输入订单号，计算该订单折扣后对应的应付款p_due，价格计算方式如下：如果产品数量(quantity)小于10，则p_due = 产品单价 * 数量 * 0.95; 如果数量在10和50之间，则p_due = 产品单价 * 数量 * 0.9; 如果数量大于50，则p_due = 产品单价 * 数量 * 0.8.
``` mysql
drop function if exists cal_due_fn;

delimiter $$
create function cal_due_fn (p_orderid char(10)) returns float
reads sql data
begin
declare p_quantity int;
declare p_price float;
declare p_due decimal(10,2);
select quantity into p_quantity
from orders
where order_id = p_orderid;
select p.price into p_price
from product p, orders o
where p.product_id=o.product_id and o.order_id = p_orderid;
if (p_quantity < 10) then set p_due=p_price*p_quantity*0.95;
elseif (p_quantity < 50) then set p_due=p_price*p_quantity*0.9;
else set p_due=p_price*p_quantity*0.8;
end if;
return p_due;
end;
$$
delimiter ;

select cal_due_fn(2);
```

## 3 
- 选用一种循环结构，编写函数get_prod_fn，实现从m到n的累乘
``` mysql
drop function if exists get_prod_fn;

delimiter $$
create function get_prod_fn (m int, n int) returns int
no sql
begin 
declare start_num int default m;
declare prod int default m;
while (start_num<n) do
set start_num = start_num + 1;
set prod = prod * start_num;
end while;
return prod;
end;
$$
delimiter ;

select get_prod_fn(2,5);
```
- 选择一种循环结构，编写程序求三位水仙花数之和。
``` mysql
drop function if exists flower_fn;

delimiter $$
create function flower_fn () returns int
no sql
begin
declare start_num int default 100;
declare accum_sum int default 0;
while (start_num<1000) do
if (power(floor(start_num/100),3)+power(floor(start_num%100/10),3)+power(start_num%100%10,3))=start_num then
set accum_sum = accum_sum + start_num;
end if;
set start_num = start_num + 1;
end while;
return accum_sum;
end;
$$
delimiter ;

select flower_fn();
```



# P.S. case...when...then...else语句在SQL中的应用

## 在select中使用case...when...
例如，在student表中查询学生出生在周几。
> 注意是if函数而不是if语句。
case在使用时then直接给出结果即可，不用给出赋值表达式。

``` mysql
-- 使用if()函数
SELECT s_id, s_name, if(weekday(birthday) = 0,  'Monday', 
                        if(weekday(birthday) = 1, 'Tuesday',
                            if(weekday(birthday) = 2, 'Wednesday',
                                if(weekday(birthday) = 3, 'Thursday',
                                    if(weekday(birthday) = 4, 'Friday',
                                        if(weekday(birthday) = 5, 'Saturday', 'Sunday')))))) as week_day
FROM student
LIMIT 10;

-- 使用case
SELECT s_id, s_name, case weekday(birthday) 
                      when 0 then 'Monday'
                      when 1 then 'Tuesday'
                      when 2 then 'Wednesday'
                      when 3 then 'Thursday'
                      when 4 then 'Friday'
                      when 5 then 'Saturday'
                      else 'Sunday' end as week_day
FROM student
LIMIT 10;
```
例如，查询各门课程男生和女生的平均分
``` mysql
-- 使用if
SELECT c_id, c_name, avg(if(gender='男', score, null)) 男生平均分,
    avg(if(gender='女', score, null)) 女生平均分
from course natural join takes natural join student
group by c_id;

-- 使用case
SELECT c_id, c_name, avg(case gender when '男' then score else null end) 男生平均分,
    avg(case gender when '女' then score else null end) 女生平均分
from course natural join takes natural join student
group by c_id;
```
## 更新update
例如，完成下述更新
> 假设现在需要根据以下条件对该表的数据进行更新
> 1. 对当前工资为30000以上的员工，降薪10%
> 2. 对当前工资为25000以上且不满28000的员工，加薪20%

``` mysql
-- 条件1和条件2要在1个语句中执行
update employee
set salary = case
when salary>30000 then salary*0.9
when salary>25000 and salary<28000 then salary*1.2
else salary end;
```

